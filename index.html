<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Downtime Tracker</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 6px;
    }
    th {
      background-color: #f2f2f2;
    }
    table {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>ðŸ”§ Activity Downtime Tracker</h2>

  <button onclick="loadFromServer()">ðŸ”„ Load from Server</button>
  <button onclick="saveToServer()">ðŸ’¾ Save to Server</button>

  <table id="downtimeTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Activity</th>
        <th>Equip</th>
        <th>Model</th>
        <th>Downtime</th>
        <th>Comp Code</th>
        <th>Resp</th>
        <th>Remarks</th>
        <th>Est. RFU</th>
        <th>Aging</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data will be inserted here -->
    </tbody>
  </table>

  <script>
    const GITHUB_REPO = "endobody/mpc-dashboard";
    const FILE_PATH = "data/downtime_data_clean.json";
    const TOKEN = "ghp_your_token_here"; // Replace with your actual token

    async function loadFromServer() {
      try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
          headers: {
            Authorization: `Bearer ${TOKEN}`,
            Accept: "application/vnd.github.v3.raw"
          }
        });
        if (!response.ok) throw new Error("Failed to fetch data");
        const data = await response.json();
        renderTable(data);
      } catch (error) {
        console.error("Load error:", error);
        alert("Gagal load data dari server.");
      }
    }

    function renderTable(data) {
      const tbody = document.querySelector("#downtimeTable tbody");
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.activity || ""}</td>
          <td>${item.equipment || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.downtime || ""}</td>
          <td>${item.comp_code || ""}</td>
          <td>${item.resp || ""}</td>
          <td>${item.remarks || ""}</td>
          <td>${item.est_rfu || ""}</td>
          <td>${item.aging || ""}</td>
          <td><button onclick="editRow(${index})">Edit</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function editRow(index) {
      alert("Edit functionality not implemented yet for row " + (index + 1));
    }

    async function saveToServer() {
      try {
        const rows = document.querySelectorAll("#downtimeTable tbody tr");
        const data = [];
        rows.forEach(row => {
          const cells = row.querySelectorAll("td");
          const entry = {
            activity: cells[1].innerText.trim(),
            equipment: cells[2].innerText.trim(),
            model: cells[3].innerText.trim(),
            downtime: cells[4].innerText.trim(),
            comp_code: cells[5].innerText.trim(),
            resp: cells[6].innerText.trim(),
            remarks: cells[7].innerText.trim(),
            est_rfu: cells[8].innerText.trim(),
            aging: cells[9].innerText.trim()
          };
          if (Object.values(entry).some(v => v === "")) {
            throw new Error("Semua kolom harus terisi sebelum menyimpan.");
          }
          data.push(entry);
        });

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
          headers: {
            Authorization: `Bearer ${TOKEN}`,
            Accept: "application/vnd.github.v3+json"
          }
        });
        const fileData = await getResponse.json();
        const sha = fileData.sha;

        const putResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${TOKEN}`,
            Accept: "application/vnd.github.v3+json"
          },
          body: JSON.stringify({
            message: "Update downtime data",
            content: content,
            sha: sha
          })
        });

        if (!putResponse.ok) throw new Error("Gagal menyimpan ke server.");
        alert("Data berhasil disimpan ke server.");
      } catch (error) {
        console.error("Save error:", error);
        alert("Gagal menyimpan data: " + error.message);
      }
    }
  </script>
</body>
</html>
