
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activity Downtime Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      font-size: 13px;
    }
    h2 {
      margin-bottom: 10px;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      background: #f8f8f8;
      padding: 15px;
      border-radius: 10px;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      flex: 1 1 150px;
    }
    input, textarea, select {
      padding: 5px;
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      height: 60px;
    }
    #addBtn {
      height: 40px;
      padding: 0 20px;
      background-color: #2d89ef;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      align-self: flex-end;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: left;
      word-wrap: break-word;
      font-size: 12px;
    }
    th:nth-child(1), td:nth-child(1)   { width: 10px; }
    th:nth-child(2), td:nth-child(2)   { width: 30px; }
    th:nth-child(3), td:nth-child(3)   { width: 30px; }
    th:nth-child(4), td:nth-child(4)   { width: 20px; }
    th:nth-child(5), td:nth-child(5)   { width: 60px; }
    th:nth-child(6), td:nth-child(6)   { width: 110px; }
    th:nth-child(7), td:nth-child(7)   { width: 20px; }
    th:nth-child(8), td:nth-child(8)   { width: 550px; }
    th:nth-child(9), td:nth-child(9)   { width: 60px; }
    th:nth-child(10), td:nth-child(10){ width: 20px; }
    th:nth-child(11), td:nth-child(11){ width: 50px; }
    button.action {
      margin-right: 5px;
      padding: 3px 6px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .edit-btn { background-color: #ffc107; color: black; }
    .delete-btn { background-color: #e74c3c; color: white; }
  </style>
</head>
<body>

  <h2>üîß Activity Downtime Tracker</h2>

  <form id="dataForm">
    <label>Activity
      <input type="text" id="activity" required />
    </label>
    <label>Equip
      <input type="text" id="equip" required />
    </label>
    <label>Model
      <input type="text" id="model" required />
    </label>
    <label>Downtime
      <input type="datetime-local" id="downtime" required />
    </label>
    <label>Comp Code
      <input type="text" id="compCode" />
    </label>
    <label>Resp
      <input type="text" id="resp" />
    </label>
    <label style="flex: 1 1 100%;">Remaks
      <textarea id="remaks"></textarea>
    </label>
    <label>Est. RFU
      <input type="datetime-local" id="estRfu" />
    </label>
    <button type="submit" id="addBtn">Add</button>
  </form>

  <div style="margin-bottom: 20px;">
    <button onclick="loadFromGitHub()">üîÑ Load from Server</button>
    <button onclick="saveToGitHub()">üíæ Save to Server</button>
  </div>

  <table id="data-table">
    <thead>
      <tr>
        <th>No</th>
        <th>Activity</th>
        <th>Equip</th>
        <th>Model</th>
        <th>Downtime</th>
        <th>Comp Code</th>
        <th>Resp</th>
        <th>Remaks</th>
        <th>Est. RFU</th>
        <th>Aging</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById("dataForm");
    const tableBody = document.querySelector("#data-table tbody");
    let editIndex = null;

    const GITHUB_TOKEN = "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";
    const REPO = "endboedy/Daily-Job";
    const FILE_PATH = "data/downtime_data.json";

    function calculateAging(downtime) {
      const now = new Date();
      const dt = new Date(downtime);
      const diff = Math.floor((now - dt) / (1000 * 60 * 60 * 24));
      return `${diff} d`;
    }

    function renderTable() {
      let data = JSON.parse(localStorage.getItem("downtimeData") || "[]");
      data.sort((a, b) => a.activity.localeCompare(b.activity));
      tableBody.innerHTML = "";
      data.forEach((item, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.activity}</td>
          <td>${item.equip}</td>
          <td>${item.model}</td>
          <td>${item.downtime}</td>
          <td>${item.compCode}</td>
          <td>${item.resp}</td>
          <td>${item.remaks}</td>
          <td>${item.estRfu}</td>
          <td>${calculateAging(item.downtime)}</td>
          <td>
            <button class="action edit-btn" onclick="editRow(${index})">Edit</button>
            <button class="action delete-btn" onclick="deleteRow(${index})">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function resetForm() {
      form.reset();
      editIndex = null;
      document.getElementById("addBtn").textContent = "Add";
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const item = {
        activity: document.getElementById("activity").value,
        equip: document.getElementById("equip").value,
        model: document.getElementById("model").value,
        downtime: document.getElementById("downtime").value,
        compCode: document.getElementById("compCode").value,
        resp: document.getElementById("resp").value,
        remaks: document.getElementById("remaks").value.replace(/\n/g, "<br>"),
        estRfu: document.getElementById("estRfu").value,
      };
      let data = JSON.parse(localStorage.getItem("downtimeData") || "[]");
      if (editIndex === null) {
        data.push(item);
      } else {
        data[editIndex] = item;
      }
      localStorage.setItem("downtimeData", JSON.stringify(data));
      renderTable();
      resetForm();
    });

    function editRow(index) {
      const data = JSON.parse(localStorage.getItem("downtimeData") || "[]");
      const item = data[index];
      document.getElementById("activity").value = item.activity;
      document.getElementById("equip").value = item.equip;
      document.getElementById("model").value = item.model;
      document.getElementById("downtime").value = item.downtime;
      document.getElementById("compCode").value = item.compCode;
      document.getElementById("resp").value = item.resp;
      document.getElementById("remaks").value = item.remaks.replace(/<br>/g, "\n");
      document.getElementById("estRfu").value = item.estRfu;
      editIndex = index;
      document.getElementById("addBtn").textContent = "Update";
    }

    function deleteRow(index) {
      let data = JSON.parse(localStorage.getItem("downtimeData") || "[]");
      data.splice(index, 1);
      localStorage.setItem("downtimeData", JSON.stringify(data));
      renderTable();
    }

    async function loadFromGitHub() {
      const url = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;
      const response = await fetch(url, {
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        }
      });
      const file = await response.json();
      const content = atob(file.content);
      localStorage.setItem("downtimeData", content);
      renderTable();
      alert("‚úÖ Data berhasil dimuat dari server.");
    }

    async function saveToGitHub() {
      const url = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;
      const data = JSON.parse(localStorage.getItem("downtimeData") || "[]");
      const content = btoa(JSON.stringify(data, null, 2));

      const getRes = await fetch(url, {
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        }
      });
      const file = await getRes.json();

      const updateRes = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
        body: JSON.stringify({
          message: "Update downtime data",
          content: content,
          sha: file.sha
        })
      });

      if (updateRes.ok) {
        alert("‚úÖ Data berhasil disimpan ke server.");
      } else {
        alert("‚ùå Gagal menyimpan data ke server.");
      }
    }

    window.onload = renderTable;
  </script>
</body>
</html>
